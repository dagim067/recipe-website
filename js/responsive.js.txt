// ===== RECIPES.JS - Recipes page functionality =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('Recipes page loaded');
    
    // ===== SAMPLE RECIPES DATA =====
    let recipes = [
        {
            id: 1,
            title: "Creamy Garlic Pasta",
            category: "dinner",
            time: 20,
            ingredients: [
                "200g pasta",
                "3 cloves garlic, minced",
                "1 cup heavy cream",
                "1/2 cup grated Parmesan",
                "2 tbsp butter",
                "Salt and pepper to taste",
                "Fresh parsley for garnish"
            ],
            instructions: [
                "Cook pasta according to package directions.",
                "In a large pan, melt butter over medium heat.",
                "Add minced garlic and sauté until fragrant (1-2 minutes).",
                "Pour in heavy cream and bring to a simmer.",
                "Stir in Parmesan cheese until melted and creamy.",
                "Drain pasta and add to the sauce, tossing to coat.",
                "Season with salt and pepper.",
                "Garnish with fresh parsley and serve immediately."
            ],
            image: "https://images.unsplash.com/photo-1563379926898-05f4575a45d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: false
        },
        {
            id: 2,
            title: "Avocado Salad",
            category: "lunch",
            time: 15,
            ingredients: [
                "2 ripe avocados",
                "1 cup cherry tomatoes, halved",
                "1/2 red onion, thinly sliced",
                "1 cucumber, diced",
                "Juice of 1 lime",
                "2 tbsp olive oil",
                "Fresh cilantro",
                "Salt and pepper to taste"
            ],
            instructions: [
                "Cut avocados in half, remove pit, and dice.",
                "In a large bowl, combine avocado, tomatoes, red onion, and cucumber.",
                "In a small bowl, whisk together lime juice, olive oil, salt, and pepper.",
                "Pour dressing over salad and toss gently.",
                "Garnish with fresh cilantro.",
                "Serve immediately or chill for 30 minutes."
            ],
            image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: true
        },
        {
            id: 3,
            title: "Blueberry Pancakes",
            category: "breakfast",
            time: 25,
            ingredients: [
                "1 cup all-purpose flour",
                "2 tbsp sugar",
                "2 tsp baking powder",
                "1/2 tsp salt",
                "1 cup milk",
                "1 large egg",
                "2 tbsp melted butter",
                "1 cup fresh blueberries",
                "Maple syrup for serving"
            ],
            instructions: [
                "In a bowl, mix flour, sugar, baking powder, and salt.",
                "In another bowl, whisk milk, egg, and melted butter.",
                "Combine wet and dry ingredients, mixing until just combined.",
                "Gently fold in blueberries.",
                "Heat a non-stick pan over medium heat.",
                "Pour 1/4 cup batter for each pancake.",
                "Cook until bubbles form, then flip and cook until golden.",
                "Serve warm with maple syrup."
            ],
            image: "https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: false
        },
        {
            id: 4,
            title: "Chocolate Chip Cookies",
            category: "dessert",
            time: 30,
            ingredients: [
                "2 1/4 cups all-purpose flour",
                "1 tsp baking soda",
                "1 tsp salt",
                "1 cup butter, softened",
                "3/4 cup granulated sugar",
                "3/4 cup brown sugar",
                "2 large eggs",
                "2 tsp vanilla extract",
                "2 cups chocolate chips"
            ],
            instructions: [
                "Preheat oven to 375°F (190°C).",
                "In a bowl, whisk flour, baking soda, and salt.",
                "In another bowl, cream butter and both sugars until fluffy.",
                "Beat in eggs one at a time, then add vanilla.",
                "Gradually mix in dry ingredients.",
                "Stir in chocolate chips.",
                "Drop rounded tablespoons onto baking sheets.",
                "Bake for 9-11 minutes until golden.",
                "Cool on wire racks."
            ],
            image: "https://images.unsplash.com/photo-1499636136210-6f4ee915583e?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: false
        },
        {
            id: 5,
            title: "Vegetable Stir Fry",
            category: ["dinner", "vegetarian"],
            time: 25,
            ingredients: [
                "2 tbsp vegetable oil",
                "1 onion, sliced",
                "2 bell peppers, sliced",
                "2 carrots, julienned",
                "1 cup broccoli florets",
                "1 cup snap peas",
                "3 cloves garlic, minced",
                "1 tbsp ginger, grated",
                "1/4 cup soy sauce",
                "2 tbsp honey",
                "1 tbsp sesame oil",
                "Cooked rice for serving"
            ],
            instructions: [
                "Heat oil in a wok or large pan over high heat.",
                "Add onion and cook for 2 minutes.",
                "Add carrots and broccoli, cook for 3 minutes.",
                "Add bell peppers, snap peas, garlic, and ginger.",
                "Cook for another 3-4 minutes until crisp-tender.",
                "In a small bowl, mix soy sauce, honey, and sesame oil.",
                "Pour sauce over vegetables and toss to coat.",
                "Serve immediately over cooked rice."
            ],
            image: "https://images.unsplash.com/photo-1546069901-d5bfd2cbfb1f?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: true
        },
        {
            id: 6,
            title: "Fruit Smoothie Bowl",
            category: "breakfast",
            time: 10,
            ingredients: [
                "2 frozen bananas",
                "1 cup frozen mixed berries",
                "1/2 cup Greek yogurt",
                "1/4 cup milk or almond milk",
                "Toppings: sliced banana, berries, granola, chia seeds, coconut flakes"
            ],
            instructions: [
                "In a blender, combine frozen bananas, berries, yogurt, and milk.",
                "Blend until smooth and creamy.",
                "Pour into a bowl.",
                "Arrange toppings on top.",
                "Enjoy immediately with a spoon."
            ],
            image: "https://images.unsplash.com/photo-1565958011703-44f9829ba187?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80",
            saved: false
        }
    ];
    
    // ===== DOM ELEMENTS =====
    const recipesGrid = document.getElementById('recipes-grid');
    const searchInput = document.getElementById('search-input');
    const clearSearch = document.getElementById('clear-search');
    const recipeModal = document.getElementById('recipe-modal');
    const detailsModal = document.getElementById('details-modal');
    const addRecipeBtn = document.getElementById('add-recipe-btn');
    const recipeForm = document.getElementById('recipe-form');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const recipeCount = document.getElementById('recipe-count');
    const noResults = document.getElementById('no-results');
    const viewSavedBtn = document.getElementById('view-saved');
    
    // ===== LOAD RECIPES FROM LOCALSTORAGE =====
    function loadRecipesFromStorage() {
        const savedRecipes = localStorage.getItem('recipebook_recipes');
        if (savedRecipes) {
            recipes = JSON.parse(savedRecipes);
        }
        updateRecipeCount();
        renderRecipes(recipes);
    }
    
    // ===== SAVE RECIPES TO LOCALSTORAGE =====
    function saveRecipesToStorage() {
        localStorage.setItem('recipebook_recipes', JSON.stringify(recipes));
        updateRecipeCount();
    }
    
    // ===== RENDER RECIPES =====
    function renderRecipes(recipesToRender) {
        recipesGrid.innerHTML = '';
        
        if (recipesToRender.length === 0) {
            noResults.style.display = 'block';
            return;
        }
        
        noResults.style.display = 'none';
        
        recipesToRender.forEach(recipe => {
            const recipeCard = createRecipeCard(recipe);
            recipesGrid.appendChild(recipeCard);
        });
    }
    
    // ===== CREATE RECIPE CARD HTML =====
    function createRecipeCard(recipe) {
        const card = document.createElement('div');
        card.className = 'recipe-card';
        card.dataset.id = recipe.id;
        card.dataset.category = Array.isArray(recipe.category) ? recipe.category.join(' ') : recipe.category;
        
        // Get category display text
        let categoryText = Array.isArray(recipe.category) ? recipe.category[0] : recipe.category;
        categoryText = categoryText.charAt(0).toUpperCase() + categoryText.slice(1);
        
        card.innerHTML = `
            <div class="recipe-image">
                <img src="${recipe.image}" alt="${recipe.title}" loading="lazy">
                <span class="recipe-time"><i class="far fa-clock"></i> ${recipe.time} min</span>
                <button class="quick-save-btn ${recipe.saved ? 'saved' : ''}" data-id="${recipe.id}">
                    <i class="${recipe.saved ? 'fas' : 'far'} fa-bookmark"></i>
                </button>
            </div>
            <div class="recipe-content">
                <div class="recipe-header">
                    <h3>${recipe.title}</h3>
                    <span class="recipe-category">${categoryText}</span>
                </div>
                <p>${recipe.ingredients.slice(0, 3).join(', ')}${recipe.ingredients.length > 3 ? '...' : ''}</p>
                <div class="recipe-actions">
                    <button class="btn-secondary view-details-btn" data-id="${recipe.id}">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    <button class="btn-secondary quick-view-btn" data-id="${recipe.id}">
                        <i class="fas fa-list"></i> Quick View
                    </button>
                </div>
            </div>
        `;
        
        // Add event listeners
        card.querySelector('.view-details-btn').addEventListener('click', () => showRecipeDetails(recipe.id));
        card.querySelector('.quick-save-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSaveRecipe(recipe.id);
        });
        card.querySelector('.quick-view-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showQuickView(recipe);
        });
        
        card.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                showRecipeDetails(recipe.id);
            }
        });
        
        return card;
    }
    
    // ===== SHOW RECIPE DETAILS =====
    function showRecipeDetails(recipeId) {
        const recipe = recipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        // Update modal content
        document.getElementById('detail-title').textContent = recipe.title;
        document.getElementById('detail-category').textContent = 
            Array.isArray(recipe.category) ? recipe.category.join(', ') : recipe.category;
        document.getElementById('detail-time').textContent = `${recipe.time} minutes`;
        document.getElementById('detail-img').src = recipe.image;
        document.getElementById('detail-img').alt = recipe.title;
        
        // Update ingredients list
        const ingredientsList = document.getElementById('detail-ingredients');
        ingredientsList.innerHTML = '';
        recipe.ingredients.forEach(ingredient => {
            const li = document.createElement('li');
            li.textContent = ingredient;
            ingredientsList.appendChild(li);
        });
        
        // Update instructions list
        const instructionsList = document.getElementById('detail-instructions');
        instructionsList.innerHTML = '';
        recipe.instructions.forEach((instruction, index) => {
            const li = document.createElement('li');
            li.textContent = instruction;
            instructionsList.appendChild(li);
        });
        
        // Update save button
        const saveBtn = document.getElementById('save-recipe-btn');
        saveBtn.innerHTML = recipe.saved ? 
            '<i class="fas fa-bookmark"></i> Saved' : 
            '<i class="far fa-bookmark"></i> Save Recipe';
        saveBtn.onclick = () => {
            toggleSaveRecipe(recipeId);
            saveBtn.innerHTML = recipe.saved ? 
                '<i class="fas fa-bookmark"></i> Saved' : 
                '<i class="far fa-bookmark"></i> Save Recipe';
        };
        
        // Show modal
        detailsModal.style.display = 'flex';
    }
    
    // ===== SHOW QUICK VIEW =====
    function showQuickView(recipe) {
        const quickView = document.createElement('div');
        quickView.className = 'quick-view-modal';
        quickView.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2001;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        `;
        
        quickView.innerHTML = `
            <h3>${recipe.title}</h3>
            <p><strong>Prep Time:</strong> ${recipe.time} minutes</p>
            <p><strong>Ingredients:</strong></p>
            <ul>
                ${recipe.ingredients.slice(0, 5).map(ing => `<li>${ing}</li>`).join('')}
                ${recipe.ingredients.length > 5 ? '<li>...</li>' : ''}
            </ul>
            <button class="btn-primary full-recipe-btn" style="margin-top: 10px;">
                View Full Recipe
            </button>
            <button class="close-quick-view" style="
                position: absolute;
                top: 10px;
                right: 10px;
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
            ">&times;</button>
        `;
        
        document.body.appendChild(quickView);
        
        // Add event listeners
        quickView.querySelector('.full-recipe-btn').addEventListener('click', () => {
            document.body.removeChild(quickView);
            showRecipeDetails(recipe.id);
        });
        
        quickView.querySelector('.close-quick-view').addEventListener('click', () => {
            document.body.removeChild(quickView);
        });
        
        // Close when clicking outside
        quickView.addEventListener('click', (e) => {
            if (e.target === quickView) {
                document.body.removeChild(quickView);
            }
        });
    }
    
    // ===== TOGGLE SAVE RECIPE =====
    function toggleSaveRecipe(recipeId) {
        const recipe = recipes.find(r => r.id === recipeId);
        if (!recipe) return;
        
        recipe.saved = !recipe.saved;
        
        // Update button in grid
        const saveBtn = document.querySelector(`.quick-save-btn[data-id="${recipeId}"]`);
        if (saveBtn) {
            saveBtn.classList.toggle('saved');
            saveBtn.innerHTML = recipe.saved ? 
                '<i class="fas fa-bookmark"></i>' : 
                '<i class="far fa-bookmark"></i>';
        }
        
        // Update in details modal if open
        const detailsSaveBtn = document.getElementById('save-recipe-btn');
        if (detailsSaveBtn) {
            detailsSaveBtn.innerHTML = recipe.saved ? 
                '<i class="fas fa-bookmark"></i> Saved' : 
                '<i class="far fa-bookmark"></i> Save Recipe';
        }
        
        saveRecipesToStorage();
        showNotification(recipe.saved ? 'Recipe saved!' : 'Recipe removed from saved', 'success');
    }
    
    // ===== SEARCH FUNCTIONALITY =====
    function searchRecipes(query) {
        if (!query.trim()) {
            renderRecipes(recipes);
            return;
        }
        
        const filtered = recipes.filter(recipe => 
            recipe.title.toLowerCase().includes(query.toLowerCase()) ||
            recipe.ingredients.some(ing => ing.toLowerCase().includes(query.toLowerCase()))
        );
        
        renderRecipes(filtered);
    }
    
    // ===== FILTER RECIPES =====
    function filterRecipes(category) {
        // Update active filter button
        filterButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === category);
        });
        
        if (category === 'all') {
            renderRecipes(recipes);
            return;
        }
        
        const filtered = recipes.filter(recipe => {
            if (Array.isArray(recipe.category)) {
                return recipe.category.includes(category);
            }
            return recipe.category === category;
        });
        
        renderRecipes(filtered);
    }
    
    // ===== VIEW SAVED RECIPES =====
    function viewSavedRecipes() {
        const saved = recipes.filter(recipe => recipe.saved);
        renderRecipes(saved);
        showNotification(`Showing ${saved.length} saved recipes`, 'info');
    }
    
    // ===== ADD NEW RECIPE =====
    function addNewRecipe(formData) {
        const newRecipe = {
            id: Date.now(), // Simple ID generation
            title: formData.get('title'),
            category: formData.get('category'),
            time: parseInt(formData.get('time')),
            ingredients: formData.get('ingredients').split('\n').filter(line => line.trim()),
            instructions: formData.get('instructions').split('\n').filter(line => line.trim()),
            image: formData.get('image') || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80',
            saved: false
        };
        
        recipes.unshift(newRecipe); // Add to beginning
        saveRecipesToStorage();
        renderRecipes(recipes);
        showNotification('Recipe added successfully!', 'success');
    }
    
    // ===== UPDATE RECIPE COUNT =====
    function updateRecipeCount() {
        recipeCount.textContent = recipes.length;
    }
    
    // ===== EVENT LISTENERS =====
    
    // Search
    searchInput.addEventListener('input', (e) => {
        searchRecipes(e.target.value);
    });
    
    clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        searchRecipes('');
    });
    
    // Filters
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterRecipes(btn.dataset.filter);
        });
    });
    
    // View saved recipes
    viewSavedBtn.addEventListener('click', viewSavedRecipes);
    
    // Add recipe modal
    addRecipeBtn.addEventListener('click', () => {
        recipeModal.style.display = 'flex';
    });
    
    // Close modals
    document.querySelectorAll('.close-modal, .close-details').forEach(btn => {
        btn.addEventListener('click', () => {
            recipeModal.style.display = 'none';
            detailsModal.style.display = 'none';
        });
    });
    
    // Close modals when clicking outside
    [recipeModal, detailsModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Add recipe form
    recipeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(recipeForm);
        addNewRecipe(formData);
        recipeForm.reset();
        recipeModal.style.display = 'none';
    });
    
    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            recipeModal.style.display = 'none';
            detailsModal.style.display = 'none';
        }
        
        // Ctrl/Cmd + N to add new recipe
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            addRecipeBtn.click();
        }
    });
    
    // ===== INITIALIZE =====
    loadRecipesFromStorage();
    
    // Add custom styles for this page
    const style = document.createElement('style');
    style.textContent = `
        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .recipe-category {
            background: #e8f6f3;
            color: #1abc9c;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .recipe-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .recipe-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .quick-save-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-save-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .quick-save-btn.saved {
            color: #e74c3c;
        }
        
        .quick-view-modal ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .quick-view-modal li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .recipe-actions {
                flex-direction: column;
            }
        }
    `;
    document.head.appendChild(style);
    
    console.log('Recipes page initialized');
});